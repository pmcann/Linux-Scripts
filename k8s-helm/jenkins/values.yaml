controller:
  image:
    tag: lts-jdk17

  # Disable the sidecar that writes extra JCasC files
  sidecars:
    configAutoReload:
      enabled: false

  # Web service exposure
  serviceType: NodePort
  servicePort: 8080
  nodePort: 32010

  # Consolidated plugin set
  installPlugins:
    - configuration-as-code
    - kubernetes
    - workflow-aggregator
    - git
    - git-client
    - docker-workflow
    - pipeline-utility-steps
    - pipeline-stage-view
    - credentials
    - credentials-binding
    - plain-credentials
    - ssh-credentials
    - scm-api
    - script-security
    - structs
    - token-macro
    - jackson2-api
    - snakeyaml-api
    - kubernetes-credentials-provider
    - job-dsl
    - github
    - github-branch-source
    - ansicolor
    - timestamper
    - matrix-auth

  JCasC:
    enabled: true
    defaultConfig: false
    configScripts:
      # Single source of truth â€” everything in one file
      casc: |
        jenkins:
          systemMessage: "Managed via Configuration-as-Code"
          securityRealm:
            local:
              allowsSignup: false
              users:
                - id: "admin"
                  password: "${JENKINS_ADMIN_PASSWORD}"
          authorizationStrategy:
            loggedInUsersCanDoAnything:
              allowAnonymousRead: false

          # ---- Kubernetes cloud (agent pods)
          clouds:
            - kubernetes:
                name: "kubernetes"
                serverUrl: "https://kubernetes.default.svc"
                skipTlsVerify: true
                namespace: "jenkins"
                jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
                jenkinsTunnel: "jenkins-agent.jenkins.svc.cluster.local:50000"
                containerCapStr: "10"
                templates:
                  # base template for generic shell steps
                  - name: "base"
                    label: "k8s"
                    serviceAccount: "jenkins"
                    yamlMergeStrategy: "override"
                    nodeUsageMode: "NORMAL"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:jdk17"  # multi-arch
                        args: '${computer.jnlpmac} ${computer.name}'
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"
                      - name: "busybox"
                        image: "alpine:3.20"
                        command: "cat"                        # scalar (not a list)
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"

                  # kaniko template for container builds
                  - name: "kaniko"
                    label: "k8s-kaniko"
                    serviceAccount: "jenkins"
                    nodeUsageMode: "NORMAL"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:jdk17"
                        args: '${computer.jnlpmac} ${computer.name}'
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"
                      - name: "kaniko"
                        image: "gcr.io/kaniko-project/executor:latest"
                        command: "/busybox/sh"
                        args: "-c tail -f /dev/null"   # keep the sidecar running
                        shell: "/busybox/sh"           # used by Jenkins `sh` steps
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"

        credentials:
          system:
            domainCredentials:
              - credentials:
                  - string:
                      id: "github-token"
                      secret: "${GITHUB_TOKEN}"
                      description: "GitHub Personal Access Token"
                  - usernamePassword:
                      id: "ecr-creds"
                      username: "AWS"
                      password: "${ECR_PASSWORD}"
                      description: "ECR login token"

        unclassified:
          location:
            url: "http://jenkins.jenkins.svc.cluster.local:8080"

      # Guardrail: ensure no extra kubernetescloud.yaml is generated
      # kubernetescloud: null

# Durable storage (your preserved EBS via PVC)
persistence:
  enabled: true
  existingClaim: jenkins

# RBAC so kubernetes-credentials-provider can read Secrets
rbac:
  create: true
  readSecrets: true

serviceAccount:
  create: true
  name: jenkins

