controller:
  image:
    tag: lts-jdk17

  sidecars:
    configAutoReload:
      enabled: false

  # Web service exposure (matches what you already run)
  serviceType: NodePort
  servicePort: 8080
  nodePort: 32010

  installPlugins:
    - configuration-as-code
    - kubernetes
    - workflow-aggregator
    - git
    - docker-workflow
    - credentials
    - plain-credentials
    - ssh-credentials
    - git-client
    - scm-api
    - script-security
    - structs
    - token-macro
    - jackson2-api
    - snakeyaml-api
    - kubernetes-credentials-provider
    - job-dsl
    - github
    - github-branch-source

  JCasC:
    enabled: true
    defaultConfig: false
    configScripts:
      casc: |
        jenkins:
          systemMessage: "Managed via Configuration-as-Code"
          securityRealm:
            local:
              allowsSignup: false
              users:
                - id: "admin"
                  password: "${JENKINS_ADMIN_PASSWORD}"
          authorizationStrategy:
            loggedInUsersCanDoAnything:
              allowAnonymousRead: false

          # <<< KUBERNETES CLOUD (agent pods) >>>
          clouds:
            - kubernetes:
                name: "kubernetes"
                serverUrl: "https://kubernetes.default.svc"
                skipTlsVerify: true
                namespace: "jenkins"
                jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
                jenkinsTunnel: "jenkins-agent.jenkins.svc.cluster.local:50000"
                containerCapStr: "10"
                templates:
                  - name: "base"
                    label: "k8s"
                    serviceAccount: "jenkins"
                    yamlMergeStrategy: "override"
                    nodeUsageMode: "NORMAL"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:jdk17"   # multi-arch
                        args: '${computer.jnlpmac} ${computer.name}'
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"
                      - name: "busybox"
                        image: "alpine:3.20"
                        command: "cat"                           # scalar (not a list)
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"

                  - name: "kaniko"
                    label: "k8s-kaniko"
                    serviceAccount: "jenkins"
                    nodeUsageMode: "NORMAL"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:jdk17"   # multi-arch
                        args: '${computer.jnlpmac} ${computer.name}'
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"
                      - name: "kaniko"
                        image: "gcr.io/kaniko-project/executor:latest"
                        command: "/busybox/cat"                 # kaniko image has no /bin/sh
                        shell: "/busybox/sh"                    # shell for `sh` steps
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"

        credentials:
          system:
            domainCredentials:
              - credentials:
                  - string:
                      id: "github-token"
                      secret: "${GITHUB_TOKEN}"
                      description: "GitHub Personal Access Token"
                  - usernamePassword:
                      id: "ecr-creds"
                      username: "AWS"
                      password: "${ECR_PASSWORD}"
                      description: "ECR login token"

        unclassified:
          location:
            url: "http://jenkins.jenkins.svc.cluster.local:8080"

      # Hard override to prevent the chart from generating a second JCasC file
      kubernetescloud: null

# Durable storage (binds to your preserved EBS via existing PVC)
persistence:
  enabled: true
  existingClaim: jenkins

# RBAC so the kubernetes-credentials-provider can read Secrets
rbac:
  create: true
  readSecrets: true

serviceAccount:
  create: true
  name: jenkins

